name: Sync Upstream

on:
  schedule:
    # Check weekly on Mondays at 9am UTC
    - cron: '0 9 * * 1'
  workflow_dispatch: # Allow manual trigger

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Configure Git
        run: |
          git config user.name 'github-actions[bot]'
          git config user.email 'github-actions[bot]@users.noreply.github.com'

      - name: Add upstream remote
        run: git remote add upstream https://github.com/sindresorhus/transliterate.git || true

      - name: Fetch upstream
        run: git fetch upstream

      - name: Check for upstream changes
        id: check
        run: |
          UPSTREAM_COMMITS=$(git rev-list HEAD..upstream/main --count)
          echo "commits=$UPSTREAM_COMMITS" >> $GITHUB_OUTPUT
          if [ "$UPSTREAM_COMMITS" -gt 0 ]; then
            echo "Upstream has $UPSTREAM_COMMITS new commit(s)"
          fi

      - name: Create sync branch and PR
        if: steps.check.outputs.commits > 0
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          BRANCH="sync-upstream-$(date +%Y%m%d)"
          git checkout -b $BRANCH
          git merge upstream/main --no-edit || {
            echo "Merge conflict detected - manual intervention needed"
            git merge --abort
            gh issue create \
              --title "Upstream sync has conflicts" \
              --body "Automated sync with upstream found merge conflicts. Manual merge required.

          Run locally:
          \`\`\`bash
          git fetch upstream
          git merge upstream/main
          \`\`\`"
            exit 0
          }
          git push origin $BRANCH
          gh pr create \
            --title "Sync with upstream" \
            --body "Automated PR to sync with upstream changes from sindresorhus/transliterate.

          Please review and ensure CJS build still works after merging." \
            --base main \
            --head $BRANCH
